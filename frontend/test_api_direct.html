<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试API直接调用</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .participant { border: 1px solid #ccc; margin: 10px; padding: 10px; }
        .file-preview { width: 200px; height: 150px; border: 1px solid #ddd; margin: 5px; }
        .preview-image { width: 100%; height: 100%; object-fit: cover; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>测试任务API直接调用</h1>
    <button onclick="testAPI()">测试API</button>
    <div id="results"></div>

    <script>
        async function testAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>正在测试...</p>';

            try {
                const taskId = '9ffd36b9-f064-4a7c-b279-b435d58c3043';
                const response = await fetch(`/api/tasks/${taskId}/`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('API响应数据:', data);

                let html = '<h2>API测试结果</h2>';
                html += `<p class="success">✅ API调用成功</p>`;
                html += `<p>任务标题: ${data.title}</p>`;
                html += `<p>参与者数量: ${data.participants ? data.participants.length : 0}</p>`;

                if (data.participants) {
                    data.participants.forEach((participant, index) => {
                        html += `<div class="participant">`;
                        html += `<h3>参与者 ${index + 1}: ${participant.participant.username}</h3>`;
                        html += `<p>提交内容: ${participant.submission_text ? '有' : '无'}</p>`;
                        html += `<p>提交文件: ${participant.submission_files ? participant.submission_files.length : 0} 个</p>`;

                        if (participant.submission_files && participant.submission_files.length > 0) {
                            participant.submission_files.forEach((file, fileIndex) => {
                                html += `<div class="file-preview">`;
                                html += `<p>文件 ${fileIndex + 1}: ${file.file_type}</p>`;
                                html += `<p>是图片: ${file.is_image}</p>`;
                                html += `<p>URL: <a href="${file.file_url}" target="_blank">${file.file_url}</a></p>`;

                                if (file.is_image) {
                                    html += `<img src="${file.file_url}" class="preview-image"
                                           onload="console.log('图片加载成功:', '${file.file_url}')"
                                           onerror="console.error('图片加载失败:', '${file.file_url}'); this.style.border='2px solid red';">`;
                                }
                                html += `</div>`;
                            });
                        }

                        html += `</div>`;
                    });
                }

                resultsDiv.innerHTML = html;

            } catch (error) {
                console.error('API测试失败:', error);
                resultsDiv.innerHTML = `<p class="error">❌ API测试失败: ${error.message}</p>`;
            }
        }

        // 页面加载时自动测试
        window.onload = function() {
            testAPI();
        };
    </script>
</body>
</html>