<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•å›¾ç‰‡æ˜¾ç¤ºé—®é¢˜</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .participant {
            border: 2px solid #e0e0e0;
            margin: 15px 0;
            padding: 20px;
            border-radius: 8px;
            background: #fafafa;
        }
        .participant h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .file-preview {
            width: 200px;
            height: 150px;
            border: 2px solid #ddd;
            margin: 10px;
            display: inline-block;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background: #f9f9f9;
        }
        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .preview-image:hover {
            transform: scale(1.05);
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .file-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .test-results {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è°ƒè¯•å¤šäººä»»åŠ¡å›¾ç‰‡æ˜¾ç¤ºé—®é¢˜</h1>
        <button onclick="testImageDisplay()" style="padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">å¼€å§‹æµ‹è¯•</button>

        <div id="results"></div>
        <div id="debug-info" class="debug-info"></div>
    </div>

    <script>
        async function testImageDisplay() {
            const resultsDiv = document.getElementById('results');
            const debugDiv = document.getElementById('debug-info');

            resultsDiv.innerHTML = '<p class="loading">ğŸ”„ æ­£åœ¨æµ‹è¯•å›¾ç‰‡æ˜¾ç¤º...</p>';
            debugDiv.innerHTML = '';

            try {
                const taskId = '9ffd36b9-f064-4a7c-b279-b435d58c3043';
                console.log('ğŸ¯ å¼€å§‹æµ‹è¯•ä»»åŠ¡:', taskId);

                // æµ‹è¯•APIè°ƒç”¨
                const response = await fetch(`/api/tasks/${taskId}/`);
                console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('ğŸ“Š å®Œæ•´APIæ•°æ®:', data);

                let html = '<div class="test-results">';
                html += '<h2>âœ… APIæµ‹è¯•ç»“æœ</h2>';
                html += `<p><strong>ä»»åŠ¡æ ‡é¢˜:</strong> ${data.title}</p>`;
                html += `<p><strong>ä»»åŠ¡çŠ¶æ€:</strong> ${data.status}</p>`;
                html += `<p><strong>å‚ä¸è€…æ•°é‡:</strong> ${data.participants ? data.participants.length : 0}</p>`;
                html += '</div>';

                let debugInfo = 'ğŸ” è°ƒè¯•ä¿¡æ¯:\n';
                debugInfo += `ä»»åŠ¡ID: ${taskId}\n`;
                debugInfo += `API URL: /api/tasks/${taskId}/\n`;
                debugInfo += `å“åº”çŠ¶æ€: ${response.status}\n`;
                debugInfo += `å‚ä¸è€…æ•°é‡: ${data.participants ? data.participants.length : 0}\n\n`;

                if (data.participants && data.participants.length > 0) {
                    data.participants.forEach((participant, index) => {
                        html += `<div class="participant">`;
                        html += `<h3>ğŸ‘¤ å‚ä¸è€… ${index + 1}: ${participant.participant.username}</h3>`;
                        html += `<p><strong>æäº¤çŠ¶æ€:</strong> ${participant.status}</p>`;
                        html += `<p><strong>æäº¤å†…å®¹:</strong> ${participant.submission_text ? 'æœ‰' : 'æ— '}</p>`;
                        html += `<p><strong>æäº¤æ–‡ä»¶:</strong> ${participant.submission_files ? participant.submission_files.length : 0} ä¸ª</p>`;

                        debugInfo += `å‚ä¸è€… ${index + 1}: ${participant.participant.username}\n`;
                        debugInfo += `  çŠ¶æ€: ${participant.status}\n`;
                        debugInfo += `  æ–‡ä»¶æ•°é‡: ${participant.submission_files ? participant.submission_files.length : 0}\n`;

                        if (participant.submission_files && participant.submission_files.length > 0) {
                            participant.submission_files.forEach((file, fileIndex) => {
                                const imageId = `img_${index}_${fileIndex}`;

                                html += `<div class="file-preview">`;
                                html += `<p><strong>æ–‡ä»¶ ${fileIndex + 1}</strong></p>`;
                                html += `<p class="file-info">ç±»å‹: ${file.file_type}</p>`;
                                html += `<p class="file-info">æ˜¯å›¾ç‰‡: ${file.is_image}</p>`;
                                html += `<p class="file-info">URL: <a href="${file.file_url}" target="_blank">${file.file_url}</a></p>`;

                                debugInfo += `  æ–‡ä»¶ ${fileIndex + 1}:\n`;
                                debugInfo += `    ID: ${file.id}\n`;
                                debugInfo += `    URL: ${file.file_url}\n`;
                                debugInfo += `    ç±»å‹: ${file.file_type}\n`;
                                debugInfo += `    æ˜¯å›¾ç‰‡: ${file.is_image}\n`;
                                debugInfo += `    æ˜¯ä¸»è¦æ–‡ä»¶: ${file.is_primary}\n`;

                                if (file.is_image) {
                                    html += `<img id="${imageId}" src="${file.file_url}" class="preview-image"
                                           alt="æäº¤å›¾ç‰‡ ${fileIndex + 1}"
                                           onload="handleImageLoad('${imageId}', '${file.file_url}')"
                                           onerror="handleImageError('${imageId}', '${file.file_url}')">`;
                                } else {
                                    html += `<p>éå›¾ç‰‡æ–‡ä»¶</p>`;
                                }
                                html += `</div>`;
                            });
                        } else {
                            html += `<p>æ— æäº¤æ–‡ä»¶</p>`;
                        }

                        html += `</div>`;
                        debugInfo += '\n';
                    });
                } else {
                    html += `<p class="error">âŒ æ²¡æœ‰æ‰¾åˆ°å‚ä¸è€…æ•°æ®</p>`;
                }

                resultsDiv.innerHTML = html;
                debugDiv.innerHTML = `<pre>${debugInfo}</pre>`;

                // å»¶è¿Ÿæ£€æŸ¥å›¾ç‰‡åŠ è½½çŠ¶æ€
                setTimeout(() => {
                    checkImageLoadStatus();
                }, 3000);

            } catch (error) {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
                resultsDiv.innerHTML = `<p class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
                debugDiv.innerHTML = `<pre>é”™è¯¯è¯¦æƒ…: ${error.stack}</pre>`;
            }
        }

        function handleImageLoad(imageId, url) {
            console.log(`âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ: ${imageId} - ${url}`);
            const img = document.getElementById(imageId);
            if (img) {
                img.style.border = '2px solid green';
                console.log(`   å°ºå¯¸: ${img.naturalWidth}x${img.naturalHeight}`);
            }
        }

        function handleImageError(imageId, url) {
            console.error(`âŒ å›¾ç‰‡åŠ è½½å¤±è´¥: ${imageId} - ${url}`);
            const img = document.getElementById(imageId);
            if (img) {
                img.style.border = '2px solid red';
                img.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
            }
        }

        function checkImageLoadStatus() {
            console.log('\nğŸ” æ£€æŸ¥æ‰€æœ‰å›¾ç‰‡åŠ è½½çŠ¶æ€:');
            const images = document.querySelectorAll('.preview-image');

            images.forEach((img, index) => {
                console.log(`å›¾ç‰‡ ${index + 1}:`);
                console.log(`  src: ${img.src}`);
                console.log(`  å®ŒæˆåŠ è½½: ${img.complete}`);
                console.log(`  è‡ªç„¶å®½åº¦: ${img.naturalWidth}`);
                console.log(`  è‡ªç„¶é«˜åº¦: ${img.naturalHeight}`);
                console.log(`  æ˜¾ç¤ºçŠ¶æ€: ${window.getComputedStyle(img).display}`);
                console.log(`  å¯è§æ€§: ${window.getComputedStyle(img).visibility}`);
                console.log(`  ä¸é€æ˜åº¦: ${window.getComputedStyle(img).opacity}`);

                if (img.naturalWidth === 0) {
                    console.log(`  âš ï¸ å›¾ç‰‡å¯èƒ½åŠ è½½å¤±è´¥æˆ–å°šæœªå®ŒæˆåŠ è½½`);
                }
            });
        }

        // ç›‘å¬æ‰€æœ‰å›¾ç‰‡é”™è¯¯
        document.addEventListener('error', function(e) {
            if (e.target.tagName === 'IMG') {
                console.error('ğŸ–¼ï¸ å…¨å±€å›¾ç‰‡é”™è¯¯æ•è·:', e.target.src);
            }
        }, true);

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹æµ‹è¯•
        window.onload = function() {
            console.log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            testImageDisplay();
        };
    </script>
</body>
</html>