# éƒ¨ç½²åˆå§‹åŒ–æŒ‡å—

æœ¬æ–‡æ¡£åŒ…å«Lockupåº”ç”¨éƒ¨ç½²æ—¶å¿…é¡»æ‰§è¡Œçš„åˆå§‹åŒ–æ­¥éª¤ï¼Œç¡®ä¿ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚

## ğŸ—ï¸ åŸºç¡€æ•°æ®åˆå§‹åŒ–

### é—®é¢˜æè¿°
çº¿ä¸Šéƒ¨ç½²æ—¶åˆ›å»ºå¸¦é”ä»»åŠ¡æŠ¥é”™ï¼š"ç³»ç»Ÿé”™è¯¯ï¼šé’¥åŒ™é“å…·ç±»å‹ä¸å­˜åœ¨"

**æ ¹æœ¬åŸå› **: æ•°æ®åº“ç¼ºå°‘ç³»ç»Ÿè¿è¡Œå¿…éœ€çš„åŸºç¡€æ•°æ®ï¼ˆItemType å’Œ StoreItemï¼‰

## è§£å†³æ–¹æ¡ˆ

### 1. è¿è¡Œæ•°æ®åˆå§‹åŒ–å‘½ä»¤

åœ¨çº¿ä¸ŠæœåŠ¡å™¨çš„Djangoé¡¹ç›®ç›®å½•ä¸­æ‰§è¡Œï¼š

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# è¿è¡Œæ•°æ®åˆå§‹åŒ–å‘½ä»¤
python manage.py init_store_data
```

### 2. å‘½ä»¤è¯´æ˜

`init_store_data` å‘½ä»¤ä¼šè‡ªåŠ¨åˆ›å»ºä»¥ä¸‹åŸºç¡€æ•°æ®ï¼š

#### ItemTypeï¼ˆé“å…·ç±»å‹ï¼‰
- ğŸ“¸ **ç›¸çº¸** (photo_paper) - ç”¨äºæ‹æ‘„ç…§ç‰‡
- ğŸ–¼ï¸ **ç…§ç‰‡** (photo) - è®°å½•ç‰¹æ®Šæ—¶åˆ»
- ğŸ¾ **æ¼‚æµç“¶** (drift_bottle) - ä¼ é€’æ¶ˆæ¯å’Œç‰©å“
- ğŸ—ï¸ **é’¥åŒ™** (key) - è§£é”å¸¦é”ä»»åŠ¡çš„ç‰¹æ®Šé’¥åŒ™
- ğŸ“ **çº¸æ¡** (note) - è®°å½•æ–‡å­—ä¿¡æ¯

#### StoreItemï¼ˆå•†åº—å•†å“ï¼‰
- ğŸ“ **ç•™è¨€çº¸æ¡** - 3ç§¯åˆ†
- ğŸ“¸ **ç›¸çº¸** - 5ç§¯åˆ†
- ğŸ¾ **æ¼‚æµç“¶** - 15ç§¯åˆ†
- ğŸ—ï¸ **é€šç”¨é’¥åŒ™** - 50ç§¯åˆ†ï¼ˆç­‰çº§è¦æ±‚2ï¼‰

### 3. éªŒè¯åˆå§‹åŒ–

è¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯æ•°æ®æ˜¯å¦æ­£ç¡®åˆ›å»ºï¼š

```bash
python manage.py shell -c "
from store.models import ItemType, StoreItem
print(f'ItemType è®°å½•æ•°: {ItemType.objects.count()}')
print(f'StoreItem è®°å½•æ•°: {StoreItem.objects.count()}')

# æ£€æŸ¥å…³é”®çš„é’¥åŒ™ç±»å‹æ˜¯å¦å­˜åœ¨
key_type = ItemType.objects.filter(name='key').first()
if key_type:
    print(f'âœ… é’¥åŒ™é“å…·ç±»å‹å­˜åœ¨: {key_type.display_name}')
else:
    print('âŒ é’¥åŒ™é“å…·ç±»å‹ä¸å­˜åœ¨ï¼')
"
```

### 4. æµ‹è¯•å¸¦é”ä»»åŠ¡åˆ›å»º

ç¡®è®¤æ•°æ®åˆå§‹åŒ–æˆåŠŸåï¼Œæµ‹è¯•åˆ›å»ºå¸¦é”ä»»åŠ¡ï¼š

```bash
# æµ‹è¯•APIï¼ˆéœ€è¦æ›¿æ¢æœ‰æ•ˆçš„tokenï¼‰
curl -X POST http://your-domain.com/api/tasks/ \
  -H "Authorization: Token your_token_here" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "æµ‹è¯•ä»»åŠ¡",
    "description": "éªŒè¯åˆå§‹åŒ–æ•°æ®",
    "task_type": "lock",
    "difficulty": "easy",
    "duration_type": "fixed",
    "duration_value": 30,
    "unlock_type": "time"
  }'
```

æˆåŠŸçš„å“åº”åº”è¯¥åŒ…å«ä»»åŠ¡æ•°æ®ï¼Œè€Œä¸æ˜¯é”™è¯¯æ¶ˆæ¯ã€‚

## å‘½ä»¤ç‰¹æ€§

### å¹‚ç­‰æ€§
- å‘½ä»¤å¯ä»¥å®‰å…¨åœ°é‡å¤è¿è¡Œ
- ä¸ä¼šé‡å¤åˆ›å»ºå·²å­˜åœ¨çš„æ•°æ®
- é€‚åˆåœ¨CI/CDç®¡é“ä¸­ä½¿ç”¨

### å¼ºåˆ¶æ›´æ–°æ¨¡å¼
å¦‚æœéœ€è¦å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ•°æ®ï¼š

```bash
python manage.py init_store_data --force
```

### è¾“å‡ºç¤ºä¾‹

```
ğŸ”§ åˆå§‹åŒ–é“å…·ç±»å‹...
  âœ… åˆ›å»ºé“å…·ç±»å‹: æ¼‚æµç“¶ (drift_bottle)
  âœ… åˆ›å»ºé“å…·ç±»å‹: çº¸æ¡ (note)
  âœ“ é“å…·ç±»å‹å·²å­˜åœ¨: ç›¸çº¸ (photo_paper)
  âœ“ é“å…·ç±»å‹å·²å­˜åœ¨: ç…§ç‰‡ (photo)
  âœ“ é“å…·ç±»å‹å·²å­˜åœ¨: é’¥åŒ™ (key)
ğŸ“Š é“å…·ç±»å‹åˆå§‹åŒ–å®Œæˆ: æ–°åˆ›å»º 2 ä¸ªï¼Œæ›´æ–° 0 ä¸ª

ğŸ›’ åˆå§‹åŒ–å•†åº—å•†å“...
  âœ… åˆ›å»ºå•†åº—å•†å“: æ¼‚æµç“¶ - 15ç§¯åˆ†
  âœ… åˆ›å»ºå•†åº—å•†å“: ç•™è¨€çº¸æ¡ - 3ç§¯åˆ†
  âœ“ å•†åº—å•†å“å·²å­˜åœ¨: ç›¸çº¸ - 5ç§¯åˆ†
  âœ“ å•†åº—å•†å“å·²å­˜åœ¨: é€šç”¨é’¥åŒ™ - 50ç§¯åˆ†
ğŸ“Š å•†åº—å•†å“åˆå§‹åŒ–å®Œæˆ: æ–°åˆ›å»º 2 ä¸ªï¼Œæ›´æ–° 0 ä¸ª

âœ… æ‰€æœ‰åŸºç¡€æ•°æ®åˆå§‹åŒ–å®Œæˆï¼
```

## æ•…éšœæ’é™¤

### å¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥

1. **æ£€æŸ¥æ•°æ®åº“è¿æ¥**
   ```bash
   python manage.py dbshell
   ```

2. **æ£€æŸ¥è¿ç§»çŠ¶æ€**
   ```bash
   python manage.py showmigrations
   ```

3. **åº”ç”¨æœªæ‰§è¡Œçš„è¿ç§»**
   ```bash
   python manage.py migrate
   ```

### å¦‚æœå¸¦é”ä»»åŠ¡ä»ç„¶åˆ›å»ºå¤±è´¥

1. **æ£€æŸ¥ItemTypeè¡¨**
   ```bash
   python manage.py shell -c "
   from store.models import ItemType
   print('æ‰€æœ‰ItemType:')
   for it in ItemType.objects.all():
       print(f'  {it.name}: {it.display_name}')
   "
   ```

2. **æ£€æŸ¥é”™è¯¯æ—¥å¿—**
   æŸ¥çœ‹Djangoåº”ç”¨æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

3. **é‡æ–°è¿è¡Œåˆå§‹åŒ–**
   ```bash
   python manage.py init_store_data --force
   ```

## ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹

1. **å¤‡ä»½æ•°æ®åº“** - åœ¨è¿è¡Œåˆå§‹åŒ–å‘½ä»¤å‰å¤‡ä»½ç°æœ‰æ•°æ®
2. **ç»´æŠ¤çª—å£** - åœ¨ä½æµé‡æ—¶æ®µæ‰§è¡Œåˆå§‹åŒ–
3. **ç›‘æ§æ—¥å¿—** - æ‰§è¡Œåç›‘æ§åº”ç”¨æ—¥å¿—ç¡®è®¤æ— å¼‚å¸¸
4. **åŠŸèƒ½æµ‹è¯•** - åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æµ‹è¯•å¸¦é”ä»»åŠ¡åˆ›å»ºåŠŸèƒ½

---

## ğŸ å¥–åŠ±ç³»ç»Ÿé…ç½®

### é—®é¢˜æè¿°
Commit 70041e4ä¿®æ”¹äº†å¥–åŠ±æœºåˆ¶ï¼Œä»å®Œæˆä»»åŠ¡æ—¶ä¸€æ¬¡æ€§å‘æ”¾æ”¹ä¸ºæ¯å°æ—¶è‡ªåŠ¨å‘æ”¾ï¼Œä½†ç¼ºå°‘è‡ªåŠ¨åŒ–é…ç½®ã€‚

**ç—‡çŠ¶**:
- ç”¨æˆ·æ²¡æœ‰è·å¾—æ¯å°æ—¶çš„1ç§¯åˆ†å¥–åŠ±
- å®Œæˆä»»åŠ¡æ—¶ä¹Ÿæ²¡æœ‰è·å¾—æ‰€æœ‰çš„ç§¯åˆ†å¥–åŠ±

### è§£å†³æ–¹æ¡ˆ

#### 1. æ‰‹åŠ¨è¿è¡Œå¥–åŠ±å¤„ç†
```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# æ‰‹åŠ¨å¤„ç†æ‰€æœ‰å¾…å‘æ”¾çš„å¥–åŠ±
python manage.py process_rewards
```

#### 2. è®¾ç½®è‡ªåŠ¨åŒ–å®šæ—¶ä»»åŠ¡
```bash
# è¿è¡Œè‡ªåŠ¨åŒ–è®¾ç½®è„šæœ¬
python scripts/setup_cron.py

# æˆ–æ‰‹åŠ¨æ·»åŠ åˆ°crontab
echo "0 * * * * $(pwd)/venv/bin/python $(pwd)/manage.py process_rewards >> /tmp/lockup_rewards.log 2>&1" | crontab -
```

#### 3. éªŒè¯å¥–åŠ±ç³»ç»Ÿ
```bash
# æ£€æŸ¥æœ€è¿‘çš„å¥–åŠ±è®°å½•
python manage.py shell -c "
from tasks.models import HourlyReward
recent_rewards = HourlyReward.objects.all().order_by('-created_at')[:5]
print('æœ€è¿‘çš„å¥–åŠ±è®°å½•:')
for reward in recent_rewards:
    print(f'  {reward.user.username}: {reward.task.title} ç¬¬{reward.hour_count}å°æ—¶ +{reward.reward_amount}ç§¯åˆ†')
"
```

#### 4. ç›‘æ§å¥–åŠ±å¤„ç†
```bash
# æŸ¥çœ‹å¥–åŠ±å¤„ç†æ—¥å¿—
tail -f /tmp/lockup_rewards.log

# æ£€æŸ¥cronä»»åŠ¡çŠ¶æ€
crontab -l | grep process_rewards
```

### å¥–åŠ±æœºåˆ¶è¯´æ˜

1. **å°æ—¶å¥–åŠ±**: å¸¦é”ä»»åŠ¡æ¯è¿è¡Œ1å°æ—¶è‡ªåŠ¨è·å¾—1ç§¯åˆ†
2. **å®Œæˆå¥–åŠ±**: ä»»åŠ¡å®Œæˆæ—¶æ ¹æ®éš¾åº¦è·å¾—é¢å¤–å¥–åŠ±
   - Easy: +1ç§¯åˆ†
   - Normal: +2ç§¯åˆ†
   - Hard: +3ç§¯åˆ†
   - Hell: +4ç§¯åˆ†
3. **è¡¥å‘æœºåˆ¶**: ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨è¡¥å‘æ‰€æœ‰æœªå‘æ”¾çš„å°æ—¶å¥–åŠ±

---

## ğŸ¤– Telegram Bot é…ç½®

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

#### æ–¹æ¡ˆ1: ä½¿ç”¨ngrokï¼ˆæ¨èï¼‰
```bash
# 1. å¯åŠ¨ngrokéš§é“
ngrok http 8000

# 2. å¤åˆ¶HTTPS URL (å¦‚: https://abc123.ngrok.io)

# 3. è®¾ç½®webhook
source venv/bin/activate
python manage.py setup_telegram --set-webhook https://abc123.ngrok.io/api/telegram/webhook/

# 4. éªŒè¯è®¾ç½®
python manage.py setup_telegram --info
```

#### æ–¹æ¡ˆ2: ä½¿ç”¨å…¶ä»–éš§é“å·¥å…·
```bash
# Cloudflare Tunnel
brew install cloudflared
cloudflared tunnel --url http://localhost:8000

# æˆ– localtunnel
npm install -g localtunnel
lt --port 8000
```

### ç”Ÿäº§ç¯å¢ƒ

```bash
# ç›´æ¥è®¾ç½®ç”Ÿäº§ç¯å¢ƒwebhook
python manage.py setup_telegram --set-webhook https://your-domain.com/api/telegram/webhook/
```

### æ‰‹åŠ¨è®¾ç½®Webhookï¼ˆå¤‡ç”¨ï¼‰
```bash
# ä½¿ç”¨curlç›´æ¥è°ƒç”¨Telegram API
curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://your-domain.com/api/telegram/webhook/",
    "allowed_updates": ["message", "callback_query"]
  }'
```

### æµ‹è¯•ç»‘å®šæµç¨‹
1. åœ¨Telegramä¸­æ‰¾åˆ°Bot: @lock_up_bot
2. å‘é€ /start å‘½ä»¤
3. åœ¨åº”ç”¨ä¸­ç‚¹å‡»"æ‰“å¼€Telegram Bot"æŒ‰é’®
4. Botå¤„ç†ç»‘å®šé€»è¾‘å¹¶æ›´æ–°æ•°æ®åº“
5. åº”ç”¨ä¸­æ˜¾ç¤ºç»‘å®šæˆåŠŸ

### æ•…éšœæ’é™¤

**ngrokè¿æ¥å¤±è´¥**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- å°è¯•ä¸åŒregion: `ngrok http 8000 --region=ap`

**Webhookè®¾ç½®å¤±è´¥**:
- ç¡®ä¿URLæ˜¯HTTPS
- æ£€æŸ¥Bot Tokenæ˜¯å¦æ­£ç¡®
- ç¡®è®¤ç«¯å£8000å¯è®¿é—®

**Botä¸å“åº”**:
- æ£€æŸ¥DjangoæœåŠ¡å™¨è¿è¡ŒçŠ¶æ€
- æŸ¥çœ‹Djangoæ—¥å¿—ä¸­çš„webhookè¯·æ±‚
- éªŒè¯webhook URLè·¯å¾„æ­£ç¡®

**ç»‘å®šä¸æˆåŠŸ**:
- æ£€æŸ¥æ•°æ®åº“è¿æ¥
- æŸ¥çœ‹Djangoæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
- ç¡®è®¤ç”¨æˆ·å·²ç™»å½•åº”ç”¨

---

## ğŸ“‹ å®Œæ•´éƒ¨ç½²æ£€æŸ¥æ¸…å•

### å¿…é¡»æ‰§è¡Œçš„æ­¥éª¤
- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»: `python manage.py migrate`
- [ ] åˆå§‹åŒ–åŸºç¡€æ•°æ®: `python manage.py init_store_data`
- [ ] è®¾ç½®å¥–åŠ±ç³»ç»Ÿå®šæ—¶ä»»åŠ¡: `python scripts/setup_cron.py`
- [ ] é…ç½®Telegram Bot webhookï¼ˆå¦‚æœéœ€è¦ï¼‰

### éªŒè¯æ­¥éª¤
- [ ] åˆ›å»ºå¸¦é”ä»»åŠ¡æˆåŠŸ
- [ ] å¥–åŠ±ç³»ç»Ÿæ­£å¸¸å‘æ”¾ç§¯åˆ†
- [ ] Telegram Botç»‘å®šåŠŸèƒ½æ­£å¸¸
- [ ] æ‰€æœ‰APIç«¯ç‚¹æ­£å¸¸å“åº”

### ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹
1. **ç¯å¢ƒå˜é‡**: ç¡®ä¿æ‰€æœ‰æ•æ„Ÿé…ç½®é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®
2. **SSLè¯ä¹¦**: ç¡®ä¿HTTPSæ­£ç¡®é…ç½®ï¼ˆTelegram webhookè¦æ±‚ï¼‰
3. **é˜²ç«å¢™**: å¼€æ”¾å¿…è¦ç«¯å£
4. **ç›‘æ§**: è®¾ç½®åº”ç”¨å’Œæ•°æ®åº“ç›‘æ§
5. **å¤‡ä»½**: é…ç½®å®šæœŸæ•°æ®åº“å¤‡ä»½

---

ğŸ“ **åˆ›å»ºæ—¶é—´**: 2025å¹´12æœˆ10æ—¥
ğŸ”§ **ç»´æŠ¤è€…**: Claude Code Assistant
ğŸ“‹ **çŠ¶æ€**: æµ‹è¯•å®Œæˆï¼Œç”Ÿäº§å°±ç»ª